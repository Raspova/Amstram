{"version":3,"file":"_server.ts-BEmcqMPa.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/webhook/stripe/_server.ts.js"],"sourcesContent":["import { j as json } from \"../../../../../chunks/index.js\";\nimport { Client, Databases } from \"appwrite\";\nimport { S as STRIPE_WEBHOOK_SECRET, D as DATABASE_ID, a as DATABASE_ROUTE_COLLECTION_ID } from \"../../../../../chunks/private.js\";\nimport { a as PUBLIC_APPWRITE_URL, P as PUBLIC_APPWRITE_PROJECT_ID } from \"../../../../../chunks/public.js\";\nimport { s as stripe } from \"../../../../../chunks/stripe.js\";\nconst client = new Client();\nclient.setEndpoint(PUBLIC_APPWRITE_URL);\nclient.setProject(PUBLIC_APPWRITE_PROJECT_ID);\nconst database = new Databases(client);\nconst POST = async ({ request }) => {\n  const body = await request.text();\n  const signature = request.headers.get(\"stripe-signature\");\n  console.log(\"Webhook Stripe reçu\");\n  if (!signature) {\n    console.error(\"Signature manquante\");\n    return json({ success: false, error: \"Signature manquante\" }, { status: 400 });\n  }\n  let event;\n  try {\n    event = stripe.webhooks.constructEvent(\n      body,\n      signature,\n      STRIPE_WEBHOOK_SECRET\n    );\n  } catch (error) {\n    console.error(\"Erreur de vérification de signature:\", error);\n    return json({ success: false, error: \"Signature invalide\" }, { status: 400 });\n  }\n  if (event.type === \"checkout.session.completed\") {\n    const session = event.data.object;\n    console.log(\"Session complétée, métadonnées:\", session.metadata);\n    if (session.payment_status === \"paid\") {\n      try {\n        const routeId = session.metadata?.routeId;\n        if (!routeId) {\n          console.error(\"ID de route manquant dans les métadonnées\");\n          return json({ success: false, error: \"ID de route manquant\" }, { status: 400 });\n        }\n        await updateRoutePaymentStatus(routeId);\n        console.log(`Route ${routeId} marquée comme payée avec succès`);\n        return json({ success: true });\n      } catch (error) {\n        console.error(\"Erreur lors de la mise à jour du statut de paiement:\", error);\n        return json(\n          { success: false, error: \"Erreur interne lors de la mise à jour\" },\n          { status: 500 }\n        );\n      }\n    } else {\n      console.log(\"Paiement non encore finalisé, statut:\", session.payment_status);\n    }\n  }\n  return json({ success: true, received: true });\n};\nasync function updateRoutePaymentStatus(routeId) {\n  try {\n    try {\n      await database.getDocument(\n        DATABASE_ID,\n        DATABASE_ROUTE_COLLECTION_ID,\n        routeId\n      );\n    } catch (error) {\n      console.error(`Route ${routeId} non trouvée dans la base de données`);\n      throw new Error(`Route ${routeId} non trouvée`);\n    }\n    const result = await database.updateDocument(\n      DATABASE_ID,\n      DATABASE_ROUTE_COLLECTION_ID,\n      routeId,\n      {\n        is_paid: true,\n        payment_date: (/* @__PURE__ */ new Date()).toISOString(),\n        payment_status: \"paid\"\n      }\n    );\n    return result;\n  } catch (error) {\n    console.error(\"Erreur Appwrite lors de la mise à jour:\", error);\n    throw error;\n  }\n}\nexport {\n  POST\n};\n"],"names":[],"mappings":"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"}